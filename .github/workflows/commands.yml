name: Run CLI Commands via PR Comment

on:
  issue_comment:
    types: [created]

jobs:
  detect-and-run:
    runs-on: ubuntu-latest
    outputs:
      command: ${{ steps.parse.outputs.command }}
      step_outcome: ${{ steps.run-cmd.outcome }}
      has_patch: ${{ steps.meta.outputs.hasPatch }}
    if: github.event.issue.pull_request
    steps:
      - name: Parse comment
        id: parse
        uses: drewwyatt/comment-pipeline@v1
        with:
          comment: ${{ toJSON(github.event.comment) }}
          commands: |
            /run fantomas
            /run ilverify
            /run xlf
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Checkout PR branch
        if: ${{ steps.parse.outputs.command }}
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event.pull_request.head.ref }}

      - name: Install dotnet
        uses: actions/setup-dotnet@v3
        with:
          global-json-file: global.json

      - name: Run command
        id: run-cmd
        env:
          TEST_UPDATE_BSL: 1
        continue-on-error: true
        run: |
          case "${{ steps.parse.outputs.command }}" in
            "/run fantomas") dotnet fantomas . ;;
            "/run xlf") dotnet build src/Compiler /t:UpdateXlf ;;
            "/run ilverify") pwsh tests/ILVerify/ilverify.ps1 ;;
            *) echo "Unknown command" && exit 1 ;;
          esac

      - name: Create patch & metadata
        id: meta
        if: steps.parse.outputs.command
        run: |
          echo "outcome=${{ steps.run-cmd.outcome }}" > result
          if [[ "${{ steps.run-cmd.outcome }}" == "success" ]]; then
            git config user.name "GH Actions"
            git config user.email "actions@github.com"
            git diff > repo.patch || true
            if [ -s repo.patch ]; then echo "hasPatch=true" >> result; else echo "hasPatch=false" >> result; fi
          else
            echo "hasPatch=false" >> result
          fi
          cat result

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: cli-results
          path: |
            repo.patch
            result

  apply-and-report:
    needs: detect-and-run
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    if: needs.detect-and-run.outputs.command != ''
    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          name: cli-results

      - name: Read metadata
        id: read-meta
        run: |
          source result
          echo "step_outcome=$outcome" >> $GITHUB_OUTPUT
          echo "hasPatch=$hasPatch" >> $GITHUB_OUTPUT

      - name: Apply and push patch
        if: ${{ steps.read-meta.outputs.step_outcome == 'success' && steps.read-meta.outputs.hasPatch == 'true' }}
        run: |
          patch -p1 < repo.patch
          git config user.name "GH Actions"
          git config user.email "actions@github.com"
          git add -A
          git commit -m "Apply patch from `${{ needs.detect-and-run.outputs.command }}`"
          git push origin HEAD:${{ github.event.pull_request.head.ref }}

      - name: Count stats
        id: stats
        if: ${{ steps.read-meta.outputs.step_outcome == 'success' && steps.read-meta.outputs.hasPatch == 'true' }}
        run: |
          files=$(git diff --name-only HEAD~1 HEAD | wc -l)
          lines=$(git diff HEAD~1 HEAD | wc -l)
          echo "files=$files" >> $GITHUB_OUTPUT
          echo "lines=$lines" >> $GITHUB_OUTPUT
      - name: Generate and publish report
        if: always()
        env:
          COMMAND: ${{ needs.detect-and-run.outputs.command }}
          OUTCOME: ${{ needs.detect-and-run.outputs.outcome }}
          PATCH: ${{ needs.detect-and-run.outputs.hasPatch }}
        run: |
          # Build the markdown report
          report="
            # ðŸ”§ CLI Command Report

            - **Command:** \`${COMMAND}\`
            - **Outcome:** ${OUTCOME}
            
          "

          if [[ "$OUTCOME" == "success" ]]; then
            if [[ "$PATCH" == "true" ]]; then
              report+="âœ… Patch applied:
              - Files changed: ${{ steps.stats.outputs.files }}
              - Lines changed: ${{ steps.stats.outputs.lines }}"
            else
              report+="âœ… Command succeeded, no changes needed."
            fi
          else
            report+="âŒ Command **failed** â€” no patch applied."
          fi

          # Output to GitHub Actions UI
          echo "$report" >> "$GITHUB_STEP_SUMMARY"

          # Store for use in next step
          echo "$report" > pr_report.md

      - name: Comment on PR
        if: always()
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Use gh CLI to comment with multi-line markdown
          gh pr comment ${{ github.event.pull_request.number }} \
            --body-file pr_report.md
